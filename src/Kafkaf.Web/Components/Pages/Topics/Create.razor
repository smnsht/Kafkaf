@using Confluent.Kafka
@using Confluent.Kafka.Admin
@using Kafkaf.Web
@using Kafkaf.Web.Config
@using Kafkaf.Web.Models
@using Microsoft.Extensions.Caching.Memory
@using Microsoft.Extensions.Options

@page "/{clusterIdx:int}/topics/create"
@rendermode InteractiveServer

@inject IOptions<List<ClusterConfigOptions>> ClusterOptions;
@inject IMemoryCache MemoryCache


<PageTitle>Topics: Create New</PageTitle>


<h3>Create Topic</h3>

<DismissibleAlertError @ref="@alertError" />
<DismissibleAlertSuccess @ref="@alertSuccess"/>

<div class="container-fluid">
    <div class="row">
        <div class="col-8 mt-4">
            <_CreateTopicForm Model="@TopicModel" @ref="childCreateTopicForm" />
            <_CustomParametersForm CustomParameterList="@TopicModel.CustomParameters" />

            @if(loading) 
            {
                <Spinner />
            } 
            
            @if(!loading && !created)
            {
                <div class="mt-4">
                    <NavLink class="nav-link" href="@UrlBack" style="display: inline;">
                        <button type="button" class="btn btn-primary">Cancel</button>
                    </NavLink>
                    <button type="button" class="btn btn-light" @onclick="HandleValidSubmitAsync">Create</button>
                </div>
            }

            @if(created)
            {
                <NavLink class="nav-link" href="@UrlBack" style="">
                    <button type="button" class="btn btn-primary">Back to topics</button>
                </NavLink>
            }
        </div>
    </div>
</div>


@code {
    [Parameter]
    public int clusterIdx { get; set; }   


    [SupplyParameterFromQuery]
    public string? TopicName { get; set; }

    [SupplyParameterFromQuery]
    public int? Size { get; set; }

    [SupplyParameterFromQuery]
    public int? ReplicationFactor { get; set; }

    [SupplyParameterFromQuery]
    public int? Partitions { get; set; }


    private CreateTopicModel TopicModel = new();
    private _CreateTopicForm? childCreateTopicForm;
    private DismissibleAlertError? alertError;
    private DismissibleAlertSuccess? alertSuccess;

    private bool loading = false;
    private bool created = false;

    protected override void OnParametersSet()
    {
        if(!string.IsNullOrEmpty(TopicName))
        {
            TopicModel.Name = TopicName;
        }

        if (Partitions.HasValue)
        {
            TopicModel.NumPartitions = Partitions.Value;
        }

        base.OnParametersSet();
    }

    private async Task HandleValidSubmitAsync()
    {        
        if (childCreateTopicForm?.Validate() != true)
        {            
            return;
        }

        // Process the submitted data
        var newTopic = TopicModel.ToTopicSpecification();        
        var clusterConfig = ClusterOptions.Value[clusterIdx - 1];

        try
        {
            loading = true;

            await KafkaUtils.CreateTopicAsync(clusterConfig, newTopic);

            var successNotice = $"Topic '{newTopic.Name}' created successfully.";
            alertSuccess?.SetNotice(successNotice);

            // set flag
            created = true;

            // invalidate cache
            MemoryCache.Remove(clusterConfig.CacheKey());
        }
        catch (CreateTopicsException e)
        {
            var errorNotice = $"An error occurred creating topic '{newTopic.Name}': {e.Results[0].Error.Reason}";
            alertError?.SetNotice(errorNotice);
        }
        catch (Exception ex)
        {                        
            alertError?.SetNotice($"An unexpected error occurred: {ex.Message}");
            loading = false;
        }
    }    

    private string UrlBack
    {
        get => $"/{clusterIdx}/topics";
    }        
}
